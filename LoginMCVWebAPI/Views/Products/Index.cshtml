@using WebAPIJwtAuth.Application.DTOs
@model ProductResponseDto
@{
    ViewData["Title"] = "Products";
    var categories = Model.Categories.ToList();
    var brands = Model.Brands.ToList();
}
<div class="text-center">
@* 
<div class="container-fluid mt-4"> *@
    <div class="row">
        <!-- Filters Sidebar -->
        <div class="col-lg-3 col-md-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Filters
                    </h5>
                </div>
                <div class="card-body">
                    <form method="get" id="filterForm">
                        <!-- Search -->
                        <div class="mb-3">
                            <label class="form-label">Search</label>
                            <input type="text" 
                                   class="form-control" 
                                   name="search" 
                                   value="@ViewBag.SearchTerm"
                                   placeholder="Search products...">
                        </div>
                        
                        <!-- Category Filter -->
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" name="categoryId">
                                <option value="">All Categories</option>
                                @foreach (var category in categories)
                                {
                                    <option value="@category.Id" 
                                            selected="@(ViewBag.CategoryId?.ToString() == category.Id.ToString())">
                                        @category.Name
                                    </option>
                                }
                            </select>
                        </div>
                        
                        <!-- Brand Filter -->
                        <div class="mb-3">
                            <label class="form-label">Brand</label>
                            <select class="form-select" name="brandId">
                                <option value="">All Brands</option>
                                @foreach (var brand in brands)
                                {
                                    <option value="@brand.Id" 
                                            selected="@(ViewBag.BrandId?.ToString() == brand.Id.ToString())">
                                        @brand.Name
                                    </option>
                                }
                            </select>
                        </div>
                        
                        <!-- Price Range -->
                        <div class="mb-3">
                            <label class="form-label">Price Range</label>
                            <div class="row g-2">
                                <div class="col">
                                    <input type="number" 
                                           class="form-control" 
                                           name="minPrice" 
                                           placeholder="Min"
                                           value="@ViewBag.MinPrice"
                                           step="0.01">
                                </div>
                                <div class="col">
                                    <input type="number" 
                                           class="form-control" 
                                           name="maxPrice" 
                                           placeholder="Max"
                                           value="@ViewBag.MaxPrice"
                                           step="0.01">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Featured -->
                        <div class="mb-3 form-check">
                            <input type="checkbox" 
                                   class="form-check-input" 
                                   id="featuredFilter" 
                                   name="featured" 
                                   value="true"
                                   @(ViewBag.Featured == true ? "checked" : "")>
                            <label class="form-check-label" for="featuredFilter">
                                Featured Products Only
                            </label>
                        </div>
                        
                        <!-- Sort -->
                        <div class="mb-3">
                            <label class="form-label">Sort By</label>
                            <select class="form-select" name="sortBy">
                                <option value="name" selected="@(ViewBag.SortBy == "name")">Name (A-Z)</option>
                                <option value="name" selected="@(ViewBag.SortBy == "name" && !ViewBag.SortAsc)">Name (Z-A)</option>
                                <option value="price" selected="@(ViewBag.SortBy == "price" && ViewBag.SortAsc)">Price (Low to High)</option>
                                <option value="price" selected="@(ViewBag.SortBy == "price" && !ViewBag.SortAsc)">Price (High to Low)</option>
                                <option value="created" selected="@(ViewBag.SortBy == "created")">Newest First</option>
                                <option value="rating" selected="@(ViewBag.SortBy == "rating")">Highest Rated</option>
                            </select>
                        </div>
                        
                        <!-- Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search me-2"></i>Apply Filters
                            </button>
                            <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Clear Filters
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Categories -->
            @if (categories.Any())
            {
                <div class="card shadow-sm mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">Categories</h6>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            <a href="@Url.Action("Index")" 
                               class="list-group-item list-group-item-action @(ViewBag.CategoryId == null ? "active" : "")">
                                All Categories
                            </a>
                            @foreach (var category in categories)
                            {
                                <a href="@Url.Action("Index", new { categoryId = category.Id })" 
                                   class="list-group-item list-group-item-action @(ViewBag.CategoryId?.ToString() == category.Id.ToString() ? "active" : "")">
                                    @category.Name
                                    <span class="badge bg-primary float-end">@category.ProductCount</span>
                                </a>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
        
        <!-- Products Grid -->
        <div class="col-lg-9 col-md-8">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">Products</h2>
                    <p class="text-muted mb-0">
                        Showing @((Model.Page - 1) * Model.PageSize + 1)-@Math.Min(Model.Page * Model.PageSize, Model.TotalCount) 
                        of @Model.TotalCount products
                    </p>
                </div>
                
                @if (User.IsInRole("Admin") || User.IsInRole("Manager"))
                {
                    <a href="@Url.Action("Create")" class="btn btn-success">
                        <i class="fas fa-plus me-2"></i>Add Product
                    </a>
                }
            </div>
            
            <!-- Products -->
            @if (Model.Products.Any())
            {
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                    @foreach (var product in Model.Products)
                    {
                        <div class="col">
                            <div class="card product-card h-100 shadow-sm">
                                <!-- Product Image -->
                                <div class="product-image position-relative">
                                    <img src="@(product.ImageUrl ?? "/images/placeholder.png")" 
                                         class="card-img-top" 
                                         alt="@product.Name"
                                         style="height: 200px; object-fit: cover;">
                                    
                                    @if (product.HasDiscount)
                                    {
                                        <span class="badge bg-danger position-absolute top-0 end-0 m-2">
                                            -@product.DiscountPercentage%
                                        </span>
                                    }
                                    
                                    @if (product.IsFeatured)
                                    {
                                        <span class="badge bg-warning position-absolute top-0 start-0 m-2">
                                            <i class="fas fa-star me-1"></i>Featured
                                        </span>
                                    }
                                </div>
                                
                                <!-- Product Body -->
                                <div class="card-body">
                                    <!-- Category & Brand -->
                                    <div class="mb-2">
                                        <span class="badge bg-info">@product.Category?.Name</span>
                                        <span class="badge bg-secondary">@product.Brand?.Name</span>
                                    </div>
                                    
                                    <!-- Product Name -->
                                    <h5 class="card-title">
                                        <a href="@Url.Action("Details", new { id = product.Id })" 
                                           class="text-decoration-none text-dark">
                                            @product.Name
                                        </a>
                                    </h5>
                                    
                                    <!-- Description -->
                                    <p class="card-text text-muted small">
                                        @(product.Description?.Length > 100 ? 
                                            product.Description.Substring(0, 100) + "..." : 
                                            product.Description)
                                    </p>
                                    
                                    <!-- Price -->
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div>
                                            @if (product.HasDiscount)
                                            {
                                                <span class="text-muted text-decoration-line-through">
                                                    $@product.Price.ToString("N2")
                                                </span>
                                                <span class="h5 text-danger ms-2">
                                                    $@product.FinalPrice.ToString("N2")
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="h5">$@product.Price.ToString("N2")</span>
                                            }
                                        </div>
                                        
                                        <!-- Stock Status -->
                                        @if (product.IsInStock)
                                        {
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>In Stock
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times me-1"></i>Out of Stock
                                            </span>
                                        }
                                    </div>
                                    
                                    <!-- Rating -->
                                    @if (product.AverageRating.HasValue)
                                    {
                                        <div class="mb-3">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                <i class="fas fa-star @(i <= Math.Round(product.AverageRating.Value) ? "text-warning" : "text-muted")"></i>
                                            }
                                            <small class="text-muted ms-1">(@product.TotalReviews reviews)</small>
                                        </div>
                                    }
                                    
                                    <!-- Actions -->
                                    <div class="d-grid gap-2">
                                        <a href="@Url.Action("Details", new { id = product.Id })" 
                                           class="btn btn-outline-primary">
                                            <i class="fas fa-eye me-2"></i>View Details
                                        </a>
                                        
                                        @if (User.IsInRole("Admin") || User.IsInRole("Manager"))
                                        {
                                            <div class="btn-group" role="group">
                                                <a href="@Url.Action("Edit", new { id = product.Id })" 
                                                   class="btn btn-outline-warning">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <form method="post" 
                                                      action="@Url.Action("Delete", new { id = product.Id })" 
                                                      onsubmit="return confirm('Are you sure you want to delete this product?');">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" class="btn btn-outline-danger">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                
                <!-- Pagination -->
                @if (Model.TotalPages > 1)
                {
                    <nav aria-label="Page navigation" class="mt-5">
                        <ul class="pagination justify-content-center">
                            <!-- Previous -->
                            <li class="page-item @(Model.Page == 1 ? "disabled" : "")">
                                <a class="page-link" 
                                   href="@Url.Action("Index", new { 
                                       page = Model.Page - 1,
                                       search = ViewBag.SearchTerm,
                                       categoryId = ViewBag.CategoryId,
                                       brandId = ViewBag.BrandId,
                                       featured = ViewBag.Featured,
                                       minPrice = ViewBag.MinPrice,
                                       maxPrice = ViewBag.MaxPrice,
                                       sortBy = ViewBag.SortBy,
                                       sortAsc = ViewBag.SortAsc
                                   })">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                            
                            <!-- Page Numbers -->
                            @for (int i = 1; i <= Model.TotalPages; i++)
                            {
                                if (i == 1 || i == Model.TotalPages || (i >= Model.Page - 2 && i <= Model.Page + 2))
                                {
                                    <li class="page-item @(i == Model.Page ? "active" : "")">
                                        <a class="page-link" 
                                           href="@Url.Action("Index", new { 
                                               page = i,
                                               search = ViewBag.SearchTerm,
                                               categoryId = ViewBag.CategoryId,
                                               brandId = ViewBag.BrandId,
                                               featured = ViewBag.Featured,
                                               minPrice = ViewBag.MinPrice,
                                               maxPrice = ViewBag.MaxPrice,
                                               sortBy = ViewBag.SortBy,
                                               sortAsc = ViewBag.SortAsc
                                           })">
                                            @i
                                        </a>
                                    </li>
                                }
                                else if (i == Model.Page - 3 || i == Model.Page + 3)
                                {
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                }
                            }
                            
                            <!-- Next -->
                            <li class="page-item @(Model.Page == Model.TotalPages ? "disabled" : "")">
                                <a class="page-link" 
                                   href="@Url.Action("Index", new { 
                                       page = Model.Page + 1,
                                       search = ViewBag.SearchTerm,
                                       categoryId = ViewBag.CategoryId,
                                       brandId = ViewBag.BrandId,
                                       featured = ViewBag.Featured,
                                       minPrice = ViewBag.MinPrice,
                                       maxPrice = ViewBag.MaxPrice,
                                       sortBy = ViewBag.SortBy,
                                       sortAsc = ViewBag.SortAsc
                                   })">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                }
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
                    <h3>No products found</h3>
                    <p class="text-muted">Try adjusting your search or filter criteria.</p>
                    <a href="@Url.Action("Index")" class="btn btn-primary">
                        <i class="fas fa-redo me-2"></i>Clear Filters
                    </a>
                </div>
            }
        </div>
    </div>
@* </div>  *@
</div>

@section Styles {
    <style>
        .product-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .product-image {
            overflow: hidden;
        }
        
        .product-card img {
            transition: transform 0.5s ease;
        }
        
        .product-card:hover img {
            transform: scale(1.05);
        }
        
        .page-item.active .page-link {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
    </style>
}